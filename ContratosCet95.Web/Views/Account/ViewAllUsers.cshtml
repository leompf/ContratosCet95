@model ContratosCet95.Web.Models.UserListViewModel

@{
    ViewData["Title"] = "ViewAllUsers";
    Layout = "~/Views/Shared/_Layout2.cshtml";
}

<section id="main" class="container">
    <header class="major">
        <h2 style="color: white">All Users</h2>
        <p style="color: white">Manage and view all registered users</p>
    </header>

    <div class="box mb-4">
        <form id="filterForm" method="get" class="row g-3">
            <div class="col-md-3">
                <input type="text" asp-for="NameFilter" placeholder="Name" value="@Model.NameFilter" class="alpha-input" />
            </div>
            <div class="col-md-3">
                <input type="text" asp-for="EmailFilter" placeholder="Email" value="@Model.EmailFilter" class="alpha-input" />
            </div>
            <div class="col-md-3">
                <select name="role" class="alpha-select">
                    <option value="">All Roles</option>
                    @foreach (var r in Model.Roles)
                    {
                        <option value="@r.Value">@r.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-3 d-flex flex-wrap gap-2" style="margin-top: 20px">
                <input type="submit" value="Filter" class="button primary" />
                <a asp-action="ViewAllUsers" class="button alt">Reset</a>
            </div>
        </form>
    </div>

    <div class="box">
        <table class="table-wrapper">
            <thead>
                <tr>
                    <th><a href="#" class="sortable" data-sort="Name"><span>Name</span> <i class="sort-icon"></i></a></th>
                    <th><a href="#" class="sortable" data-sort="Email"><span>Email</span> <i class="sort-icon"></i></a></th>
                    <th><a href="#" class="sortable" data-sort="Role"><span>Role</span> <i class="sort-icon"></i></a></th>
                    <th>Phone</th>
                    <th>Birthdate</th>
                </tr>
            </thead>
            <tbody id="users-table-body">
                @await Html.PartialAsync("_ViewAllUsersTable", Model.Users)
            </tbody>
        </table>        
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {
            let currentSortColumn = '@ViewBag.DefaultSortColumn';
            let currentSortState = '@(ViewBag.DefaultSortDescending ? "desc" : "asc")';
            let typingTimer;
            const debounceDelay = 0;

            function updateSortIcons() {
                $(".sortable").each(function () {
                    const col = $(this).data("sort");
                    const icon = $(this).find(".sort-icon");

                    $(this).removeClass("active-sort");
                    icon.removeClass("fa-sort-up fa-sort-down fa-sort text-muted");

                    if (col === currentSortColumn) {
                        $(this).addClass("active-sort");
                        icon.addClass(currentSortState === "asc" ? "fa fa-sort-up" : "fa fa-sort-down");
                    }
                    else {
                        icon.addClass("fa fa-sort text-muted");
                    }
                });
            }

            updateSortIcons();

            function getFilters() {
                return {
                    name: $("#NameFilter").val(),
                    email: $("#EmailFilter").val(),
                    role: $("#RoleFilter").val(),
                };
            }

            function loadUsers() {
                const filters = getFilters();
                $.ajax({
                    url: '@Url.Action("ViewAllUsers", "Account")',
                    type: 'GET',
                    data: {
                        ...filters,
                        sortBy: currentSortColumn,
                        sortDescending: currentSortState === "desc"
                    },
                    success: function (result) {
                        $("#users-table-body").html(result);
                        updateSortIcons();
                    },
                    error: function () {
                        alert("Erro ao carregar os dados.");
                    }
                });
            }

            $(document).on("click", ".sortable", function (e) {
                e.preventDefault();
                const sortBy = $(this).data("sort");

                if (currentSortColumn === sortBy) {
                    currentSortState = currentSortState === "desc" ? "asc" : "desc";
                }
                else
                {
                    currentSortColumn = sortBy;
                    currentSortState = "desc";
                }

                loadUsers();
            });

            $("#NameFilter, #EmailFilter").on("keyup", function () {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(loadUsers, debounceDelay);
            });

            $("#NameFilter, #EmailFilter").on("change", loadUsers);

            $("form").on("submit", function (e) {
                e.preventDefault();
                loadUsers();
            });
        });
    </script>
}